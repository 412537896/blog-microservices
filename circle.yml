machine:
  java:
    version: oraclejdk8
  services:
    - docker

# curl --insecure --cert ~/.docker/machine/machines/ms/cert.pem --key ~/.docker/machine/machines/ms/key.pem https://docker.me:2376/images/json | jq .
dependencies:
  post:
    - pwd
    - ls -al
    - curl -iv http://localhost:2376/images/json
    - whoami
    - find ~ -name certs
    - find / -name certs
    - ./build-all.sh

# According to https://circleci.com/docs/test-metadata
test:
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
    - host=localhost ./test-all.sh
deployment:
  hub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PWD
#      - docker info
#
## Renaming the target-folder for the time being to be compliant with Shippable builds...
#      - mv target buildoutput
#      - docker build -t magnuslarsson/az-ip-api-server:master.$CIRCLE_BUILD_NUM .
#      - mv buildoutput target

      - docker tag callista/auth-server               magnuslarsson/ms-blog-auth-server:master.$CIRCLE_BUILD_NUM
      - docker tag callista/config-server             magnuslarsson/ms-blog-config-server:master.$CIRCLE_BUILD_NUM
      - docker tag callista/discovery-server          magnuslarsson/ms-blog-discovery-server:master.$CIRCLE_BUILD_NUM
      - docker tag callista/edge-server               magnuslarsson/ms-blog-edge-server:master.$CIRCLE_BUILD_NUM
      - docker tag callista/monitor-dashboard         magnuslarsson/ms-blog-monitor-dashboard:master.$CIRCLE_BUILD_NUM
      - docker tag callista/turbine                   magnuslarsson/ms-blog-turbine:master.$CIRCLE_BUILD_NUM

      - docker tag callista/product-service           magnuslarsson/ms-blog-product-service:master.$CIRCLE_BUILD_NUM
      - docker tag callista/recommendation-service    magnuslarsson/ms-blog-recommendation-service:master.$CIRCLE_BUILD_NUM
      - docker tag callista/review-service            magnuslarsson/ms-blog-review-service:master.$CIRCLE_BUILD_NUM
      - docker tag callista/product-composite-service magnuslarsson/ms-blog-product-composite-service:master.$CIRCLE_BUILD_NUM

      - docker push magnuslarsson/ms-blog-auth-server:master.$CIRCLE_BUILD_NUM
      - docker push magnuslarsson/ms-blog-config-server:master.$CIRCLE_BUILD_NUM
      - docker push magnuslarsson/ms-blog-discovery-server:master.$CIRCLE_BUILD_NUM
      - docker push magnuslarsson/ms-blog-edge-server:master.$CIRCLE_BUILD_NUM
      - docker push magnuslarsson/ms-blog-monitor-dashboard:master.$CIRCLE_BUILD_NUM
      - docker push magnuslarsson/ms-blog-turbine:master.$CIRCLE_BUILD_NUM

      - docker push magnuslarsson/ms-blog-product-service:master.$CIRCLE_BUILD_NUM
      - docker push magnuslarsson/ms-blog-recommendation-service:master.$CIRCLE_BUILD_NUM
      - docker push magnuslarsson/ms-blog-review-service:master.$CIRCLE_BUILD_NUM
      - docker push magnuslarsson/ms-blog-product-composite-service:master.$CIRCLE_BUILD_NUM
